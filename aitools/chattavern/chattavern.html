<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChatTavern - è§’è‰²å¯¹è¯</title>
    <link rel="stylesheet" href="../../css/style.css">
    <link rel="stylesheet" href="../../css/theme.css">
    <link rel="stylesheet" href="chattavern.css">
</head>
<body>
    <div class="container">
        <header class="ct-header">
            <a href="../../index.html" class="back-btn">â† è¿”å›ä¸»é¡µ</a>
            <h1>ChatTavern</h1>
            <p class="subtitle">è§’è‰²å¯¹è¯ç³»ç»Ÿ - å…¼å®¹SillyTavern</p>
        </header>

        <main class="ct-main">
            <!-- å¿«é€Ÿå¯¼å…¥åŒº -->
            <section class="quick-import">
                <div class="import-card">
                    <div class="import-icon">ğŸ“¥</div>
                    <h3>å¯¼å…¥è§’è‰²å¡</h3>
                    <p>æ‹–æ‹½PNGè§’è‰²å¡åˆ°æ­¤å¤„ï¼Œæˆ–ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</p>
                    <input type="file" id="fileInput" accept="image/png" style="display: none;">
                    <button class="btn btn-primary" id="selectFileBtn">é€‰æ‹©æ–‡ä»¶</button>
                    <small>æ”¯æŒSillyTavernæ ¼å¼çš„PNGè§’è‰²å¡</small>
                    <div class="import-help">
                        <p>ğŸ’¡ <strong>æ³¨æ„ï¼š</strong>éœ€è¦æ˜¯<strong>è§’è‰²å¡PNG</strong>ï¼Œä¸æ˜¯æ™®é€šå›¾ç‰‡</p>
                        <p>ğŸ”— è·å–è§’è‰²å¡ï¼š<a href="https://chub.ai/" target="_blank">chub.ai</a> | <a href="https://characterhub.org/" target="_blank">characterhub.org</a></p>
                    </div>
                </div>
            </section>

            <!-- è§’è‰²åˆ—è¡¨ -->
            <section class="characters-section">
                <h2>æˆ‘çš„è§’è‰² (<span id="characterCount">0</span>)</h2>

                <div id="characterList" class="character-grid">
                    <!-- è§’è‰²å¡ç‰‡å°†åŠ¨æ€æ·»åŠ åˆ°è¿™é‡Œ -->
                </div>

                <!-- ç©ºçŠ¶æ€ -->
                <div id="emptyState" class="empty-state">
                    <div class="empty-icon">ğŸ­</div>
                    <h3>è¿˜æ²¡æœ‰è§’è‰²</h3>
                    <p>å¯¼å…¥ä¸€ä¸ªPNGè§’è‰²å¡å¼€å§‹å§ï¼</p>
                    <p class="hint">ğŸ’¡ ä½ å¯ä»¥ä»SillyTavernç¤¾åŒºä¸‹è½½è§’è‰²å¡ï¼Œæˆ–è€…è‡ªå·±åˆ›å»º</p>
                </div>
            </section>

            <!-- ä½¿ç”¨æŒ‡å— -->
            <section class="guide-section">
                <h2>ä½¿ç”¨æŒ‡å—</h2>
                <div class="guide-grid">
                    <div class="guide-card">
                        <h3>ğŸ“¥ å¯¼å…¥è§’è‰²å¡</h3>
                        <p>æ‹–æ‹½PNGæ–‡ä»¶æˆ–ç‚¹å‡»"é€‰æ‹©æ–‡ä»¶"æŒ‰é’®å¯¼å…¥SillyTavernæ ¼å¼çš„è§’è‰²å¡</p>
                    </div>
                    <div class="guide-card">
                        <h3>ğŸ’¬ å¼€å§‹å¯¹è¯</h3>
                        <p>ç‚¹å‡»è§’è‰²å¡ç‰‡è¿›å…¥å¯¹è¯ç•Œé¢ï¼Œä¸è§’è‰²è¿›è¡ŒAIé©±åŠ¨çš„è‡ªç„¶å¯¹è¯</p>
                    </div>
                    <div class="guide-card">
                        <h3>âš™ï¸ é…ç½®AI</h3>
                        <p>éœ€è¦é…ç½®API Keyæ‰èƒ½ä½¿ç”¨AIå¯¹è¯åŠŸèƒ½ï¼Œæœªé…ç½®æ—¶å°†ä½¿ç”¨ç®€å•å›å¤</p>
                    </div>
                    <div class="guide-card">
                        <h3>ğŸŒ ç¤¾åŒºèµ„æº</h3>
                        <p>è®¿é—®SillyTavernç¤¾åŒºä¸‹è½½æµ·é‡è§’è‰²å¡ï¼Œå®Œå…¨å…¼å®¹ï¼</p>
                    </div>
                </div>
            </section>
        </main>

        <footer class="ct-footer">
            <p>&copy; 2025 ChatTavern | åŸºäºSillyTavernå…¼å®¹æ ¼å¼</p>
        </footer>
    </div>

    <!-- è§’è‰²ç¼–è¾‘æ¨¡æ€çª—å£ -->
    <div id="editCharacterModal" class="modal" style="display: none;">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h3>ç¼–è¾‘è§’è‰²å¡</h3>
                <button class="modal-close" id="closeEditModal">&times;</button>
            </div>

            <div class="modal-body">
                <!-- åŸºç¡€ä¿¡æ¯ -->
                <div class="config-section">
                    <h4>åŸºç¡€ä¿¡æ¯</h4>
                    <label>è§’è‰²åç§°</label>
                    <input type="text" id="editName" class="config-input" placeholder="è§’è‰²åç§°">
                </div>

                <div class="config-section">
                    <label>è§’è‰²æè¿°</label>
                    <textarea id="editDescription" class="config-textarea" rows="4" placeholder="è§’è‰²çš„èƒŒæ™¯ã€å¤–è²Œã€ç‰¹å¾ç­‰"></textarea>
                </div>

                <div class="config-section">
                    <label>æ€§æ ¼ç‰¹å¾</label>
                    <textarea id="editPersonality" class="config-textarea" rows="3" placeholder="è§’è‰²çš„æ€§æ ¼ã€è¡Œä¸ºæ–¹å¼ç­‰"></textarea>
                </div>

                <div class="config-section">
                    <label>å½“å‰åœºæ™¯</label>
                    <textarea id="editScenario" class="config-textarea" rows="3" placeholder="è§’è‰²æ‰€å¤„çš„åœºæ™¯å’Œæƒ…å¢ƒ"></textarea>
                </div>

                <div class="config-section">
                    <label>ç¬¬ä¸€æ¡æ¶ˆæ¯</label>
                    <textarea id="editFirstMessage" class="config-textarea" rows="2" placeholder="è§’è‰²çš„å¼€åœºç™½"></textarea>
                </div>

                <div class="config-section">
                    <label>æ ‡ç­¾ï¼ˆç”¨é€—å·åˆ†éš”ï¼‰</label>
                    <input type="text" id="editTags" class="config-input" placeholder="ä¾‹å¦‚ï¼šæ¸©æŸ”,å¯çˆ±,æ²»æ„ˆç³»">
                    <p class="config-hint">ç”¨é€—å·åˆ†éš”å¤šä¸ªæ ‡ç­¾</p>
                </div>

                <!-- AIå‚æ•° -->
                <div class="config-section">
                    <h4>AIå‚æ•°</h4>
                    <label>System Promptï¼ˆç³»ç»Ÿæç¤ºè¯ï¼‰</label>
                    <textarea id="editSystemPrompt" class="config-textarea" rows="6" placeholder="ç•™ç©ºåˆ™è‡ªåŠ¨æ ¹æ®è§’è‰²ä¿¡æ¯ç”Ÿæˆã€‚è‡ªå®šä¹‰System Promptå¯ä»¥æ›´ç²¾ç¡®åœ°æ§åˆ¶AIçš„å›å¤é£æ ¼"></textarea>
                    <p class="config-hint">é«˜çº§é€‰é¡¹ï¼šè‡ªå®šä¹‰System Promptä¼šè¦†ç›–é»˜è®¤ç”Ÿæˆçš„æç¤ºè¯</p>
                </div>

                <div class="config-section">
                    <label>Temperature</label>
                    <input type="number" id="editTemperature" class="config-input" min="0" max="2" step="0.1" value="0.9">
                    <p class="config-hint">æ§åˆ¶å›å¤çš„éšæœºæ€§å’Œåˆ›é€ æ€§ (0-2)</p>
                </div>

                <div class="config-section">
                    <label>Max Tokens</label>
                    <input type="number" id="editMaxTokens" class="config-input" min="100" max="8000" step="100" value="2000">
                    <p class="config-hint">å•æ¬¡å›å¤çš„æœ€å¤§é•¿åº¦</p>
                </div>
            </div>

            <div class="modal-footer">
                <button id="cancelEditCharacter" class="btn btn-secondary">å–æ¶ˆ</button>
                <button id="saveEditCharacter" class="btn btn-primary">ä¿å­˜ä¿®æ”¹</button>
            </div>
        </div>
    </div>

    <!-- è§’è‰²å¡ç‰‡æ¨¡æ¿ -->
    <template id="characterCardTemplate">
        <div class="character-card" data-id="">
            <div class="character-avatar">
                <img src="" alt="">
            </div>
            <div class="character-info">
                <h3 class="character-name"></h3>
                <p class="character-desc"></p>
                <div class="character-tags"></div>
            </div>
            <div class="character-actions">
                <button class="btn-chat">å¼€å§‹å¯¹è¯</button>
                <button class="btn-edit">ç¼–è¾‘</button>
                <button class="btn-delete">åˆ é™¤</button>
            </div>
        </div>
    </template>

    <!-- è„šæœ¬ -->
    <script src="../../js/settings-loader.js"></script>
    <script src="../../js/theme.js"></script>
    <script src="PNGCardReader.js"></script>
    <script src="PNGCardWriter.js"></script>
    <script src="CharacterCard.js"></script>
    <script src="DialogueMemory.js"></script>
    <script src="AIManager.js"></script>
    <script src="ChatTavern.js"></script>
    <script>
        // åˆå§‹åŒ–
        let chatTavern;

        document.addEventListener('DOMContentLoaded', async () => {
            chatTavern = new ChatTavern();
            await chatTavern.init();
            renderCharacterList();

            // ç»‘å®šäº‹ä»¶
            document.getElementById('selectFileBtn').addEventListener('click', () => {
                document.getElementById('fileInput').click();
            });

            document.getElementById('fileInput').addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file) {
                    await importCharacter(file);
                }
            });

            // æ‹–æ‹½æ”¯æŒ
            document.body.addEventListener('dragover', (e) => {
                e.preventDefault();
                document.body.classList.add('dragging');
            });

            document.body.addEventListener('dragleave', () => {
                document.body.classList.remove('dragging');
            });

            document.body.addEventListener('drop', async (e) => {
                e.preventDefault();
                document.body.classList.remove('dragging');

                const file = e.dataTransfer.files[0];
                if (file && file.type === 'image/png') {
                    await importCharacter(file);
                }
            });
        });

        // å¯¼å…¥è§’è‰²
        async function importCharacter(file) {
            try {
                await chatTavern.importPNGCard(file);
                alert('âœ… è§’è‰²å¡å¯¼å…¥æˆåŠŸï¼');
                renderCharacterList();
            } catch (error) {
                console.error('å¯¼å…¥é”™è¯¯:', error);

                // å‹å¥½çš„é”™è¯¯æç¤º
                let errorMsg = 'âŒ å¯¼å…¥å¤±è´¥\n\n';

                if (error.message.includes('æœªæ‰¾åˆ°è§’è‰²å¡æ•°æ®') || error.message.includes('chara')) {
                    errorMsg += 'âš ï¸ è¿™ä¸ªPNGæ–‡ä»¶ä¸åŒ…å«è§’è‰²å¡æ•°æ®ï¼\n\n';
                    errorMsg += 'ğŸ“– ä»€ä¹ˆæ˜¯è§’è‰²å¡PNGï¼Ÿ\n';
                    errorMsg += 'è§’è‰²å¡PNGä¸æ˜¯æ™®é€šå›¾ç‰‡ï¼Œè€Œæ˜¯åœ¨PNGæ–‡ä»¶ä¸­åµŒå…¥äº†è§’è‰²ä¿¡æ¯çš„ç‰¹æ®Šæ–‡ä»¶ã€‚\n\n';
                    errorMsg += 'ğŸ” å¦‚ä½•è·å–è§’è‰²å¡ï¼Ÿ\n';
                    errorMsg += '1. ä» chub.ai æˆ– characterhub.org ä¸‹è½½\n';
                    errorMsg += '2. ä½¿ç”¨SillyTavernåˆ›å»ºå¹¶å¯¼å‡º\n\n';
                    errorMsg += 'ğŸ’¡ æç¤ºï¼šæ™®é€šåŠ¨æ¼«å›¾ç‰‡æ— æ³•ä½œä¸ºè§’è‰²å¡å¯¼å…¥ã€‚';
                } else {
                    errorMsg += 'é”™è¯¯è¯¦æƒ…: ' + error.message;
                }

                alert(errorMsg);
            }
        }

        // æ¸²æŸ“è§’è‰²åˆ—è¡¨
        function renderCharacterList() {
            const characters = chatTavern.getCharacterList();
            const listEl = document.getElementById('characterList');
            const emptyEl = document.getElementById('emptyState');
            const countEl = document.getElementById('characterCount');

            countEl.textContent = characters.length;

            if (characters.length === 0) {
                emptyEl.style.display = 'block';
                listEl.style.display = 'none';
                return;
            }

            emptyEl.style.display = 'none';
            listEl.style.display = 'grid';
            listEl.innerHTML = '';

            characters.forEach(char => {
                const card = createCharacterCard(char);
                listEl.appendChild(card);
            });
        }

        // åˆ›å»ºè§’è‰²å¡ç‰‡
        function createCharacterCard(charData) {
            const character = chatTavern.characters.get(charData.id);
            const template = document.getElementById('characterCardTemplate');
            const clone = template.content.cloneNode(true);
            const card = clone.querySelector('.character-card');

            card.dataset.id = charData.id;

            const avatar = clone.querySelector('.character-avatar img');
            avatar.src = character.getSpriteUrl() || 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="40" fill="%236C63FF"/></svg>';
            avatar.alt = character.name;

            clone.querySelector('.character-name').textContent = character.name;
            clone.querySelector('.character-desc').textContent =
                character.description.substring(0, 80) + (character.description.length > 80 ? '...' : '');

            const tagsEl = clone.querySelector('.character-tags');
            character.tags.slice(0, 3).forEach(tag => {
                const tagSpan = document.createElement('span');
                tagSpan.className = 'tag';
                tagSpan.textContent = tag;
                tagsEl.appendChild(tagSpan);
            });

            clone.querySelector('.btn-chat').addEventListener('click', () => {
                location.href = `chat.html?id=${charData.id}`;
            });

            clone.querySelector('.btn-edit').addEventListener('click', () => {
                showEditCharacter(charData.id);
            });

            clone.querySelector('.btn-delete').addEventListener('click', async () => {
                if (confirm(`ç¡®å®šè¦åˆ é™¤è§’è‰²"${character.name}"å—ï¼Ÿ`)) {
                    chatTavern.deleteCharacter(charData.id);
                    renderCharacterList();
                }
            });

            return clone;
        }

        // å…¨å±€å˜é‡ï¼Œè®°å½•å½“å‰ç¼–è¾‘çš„è§’è‰²ID
        let currentEditingCharacterId = null;

        // æ˜¾ç¤ºè§’è‰²ç¼–è¾‘ç•Œé¢
        function showEditCharacter(characterId) {
            const character = chatTavern.characters.get(characterId);
            if (!character) {
                alert('è§’è‰²ä¸å­˜åœ¨');
                return;
            }

            currentEditingCharacterId = characterId;

            // å¡«å……è¡¨å•æ•°æ®
            document.getElementById('editName').value = character.name || '';
            document.getElementById('editDescription').value = character.description || '';
            document.getElementById('editPersonality').value = character.personality || '';
            document.getElementById('editScenario').value = character.scenario || '';
            document.getElementById('editFirstMessage').value = character.first_mes || '';
            document.getElementById('editTags').value = character.tags.join(', ');
            document.getElementById('editSystemPrompt').value = character.system_prompt || '';
            document.getElementById('editTemperature').value = character.temperature || 0.9;
            document.getElementById('editMaxTokens').value = character.max_tokens || 2000;

            // æ˜¾ç¤ºæ¨¡æ€çª—å£
            document.getElementById('editCharacterModal').style.display = 'flex';
        }

        // ä¿å­˜è§’è‰²ç¼–è¾‘
        function saveCharacterEdits() {
            if (!currentEditingCharacterId) {
                alert('æ— æ³•ä¿å­˜ï¼šæœªé€‰æ‹©è§’è‰²');
                return;
            }

            // æ”¶é›†è¡¨å•æ•°æ®
            const updates = {
                name: document.getElementById('editName').value.trim(),
                description: document.getElementById('editDescription').value.trim(),
                personality: document.getElementById('editPersonality').value.trim(),
                scenario: document.getElementById('editScenario').value.trim(),
                first_mes: document.getElementById('editFirstMessage').value.trim(),
                tags: document.getElementById('editTags').value.split(',').map(t => t.trim()).filter(t => t),
                system_prompt: document.getElementById('editSystemPrompt').value.trim(),
                temperature: parseFloat(document.getElementById('editTemperature').value),
                max_tokens: parseInt(document.getElementById('editMaxTokens').value)
            };

            // éªŒè¯å¿…å¡«å­—æ®µ
            if (!updates.name) {
                alert('è§’è‰²åç§°ä¸èƒ½ä¸ºç©ºï¼');
                return;
            }

            try {
                // æ›´æ–°è§’è‰²
                chatTavern.updateCharacter(currentEditingCharacterId, updates);

                // å…³é—­æ¨¡æ€çª—å£
                document.getElementById('editCharacterModal').style.display = 'none';
                currentEditingCharacterId = null;

                // åˆ·æ–°è§’è‰²åˆ—è¡¨
                renderCharacterList();

                alert('âœ… è§’è‰²ä¿¡æ¯å·²æ›´æ–°ï¼');
            } catch (error) {
                alert('âŒ ä¿å­˜å¤±è´¥: ' + error.message);
            }
        }

        // ç»‘å®šç¼–è¾‘æ¨¡æ€çª—å£çš„äº‹ä»¶
        document.addEventListener('DOMContentLoaded', () => {
            // å…³é—­æŒ‰é’®
            document.getElementById('closeEditModal').addEventListener('click', () => {
                document.getElementById('editCharacterModal').style.display = 'none';
                currentEditingCharacterId = null;
            });

            // å–æ¶ˆæŒ‰é’®
            document.getElementById('cancelEditCharacter').addEventListener('click', () => {
                document.getElementById('editCharacterModal').style.display = 'none';
                currentEditingCharacterId = null;
            });

            // ä¿å­˜æŒ‰é’®
            document.getElementById('saveEditCharacter').addEventListener('click', saveCharacterEdits);

            // ç‚¹å‡»æ¨¡æ€çª—å£å¤–éƒ¨å…³é—­
            document.getElementById('editCharacterModal').addEventListener('click', (e) => {
                if (e.target.id === 'editCharacterModal') {
                    document.getElementById('editCharacterModal').style.display = 'none';
                    currentEditingCharacterId = null;
                }
            });
        });
    </script>
</body>
</html>
