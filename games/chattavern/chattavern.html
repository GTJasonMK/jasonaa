<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChatTavern - è§’è‰²å¯¹è¯</title>
    <link rel="stylesheet" href="../../css/style.css">
    <link rel="stylesheet" href="../../css/theme.css">
    <link rel="stylesheet" href="chattavern.css">
</head>
<body>
    <div class="container">
        <header class="ct-header">
            <a href="../../index.html" class="back-btn">â† è¿”å›ä¸»é¡µ</a>
            <h1>ChatTavern</h1>
            <p class="subtitle">è§’è‰²å¯¹è¯ç³»ç»Ÿ - å…¼å®¹SillyTavern</p>
        </header>

        <main class="ct-main">
            <!-- å¿«é€Ÿå¯¼å…¥åŒº -->
            <section class="quick-import">
                <div class="import-card">
                    <div class="import-icon">ğŸ“¥</div>
                    <h3>å¯¼å…¥è§’è‰²å¡</h3>
                    <p>æ‹–æ‹½PNGè§’è‰²å¡åˆ°æ­¤å¤„ï¼Œæˆ–ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</p>
                    <input type="file" id="fileInput" accept="image/png" style="display: none;">
                    <button class="btn btn-primary" id="selectFileBtn">é€‰æ‹©æ–‡ä»¶</button>
                    <small>æ”¯æŒSillyTavernæ ¼å¼çš„PNGè§’è‰²å¡</small>
                </div>
            </section>

            <!-- è§’è‰²åˆ—è¡¨ -->
            <section class="characters-section">
                <h2>æˆ‘çš„è§’è‰² (<span id="characterCount">0</span>)</h2>

                <div id="characterList" class="character-grid">
                    <!-- è§’è‰²å¡ç‰‡å°†åŠ¨æ€æ·»åŠ åˆ°è¿™é‡Œ -->
                </div>

                <!-- ç©ºçŠ¶æ€ -->
                <div id="emptyState" class="empty-state">
                    <div class="empty-icon">ğŸ­</div>
                    <h3>è¿˜æ²¡æœ‰è§’è‰²</h3>
                    <p>å¯¼å…¥ä¸€ä¸ªPNGè§’è‰²å¡å¼€å§‹å§ï¼</p>
                    <p class="hint">ğŸ’¡ ä½ å¯ä»¥ä»SillyTavernç¤¾åŒºä¸‹è½½è§’è‰²å¡ï¼Œæˆ–è€…è‡ªå·±åˆ›å»º</p>
                </div>
            </section>

            <!-- ä½¿ç”¨æŒ‡å— -->
            <section class="guide-section">
                <h2>ä½¿ç”¨æŒ‡å—</h2>
                <div class="guide-grid">
                    <div class="guide-card">
                        <h3>ğŸ“¥ å¯¼å…¥è§’è‰²å¡</h3>
                        <p>æ‹–æ‹½PNGæ–‡ä»¶æˆ–ç‚¹å‡»"é€‰æ‹©æ–‡ä»¶"æŒ‰é’®å¯¼å…¥SillyTavernæ ¼å¼çš„è§’è‰²å¡</p>
                    </div>
                    <div class="guide-card">
                        <h3>ğŸ’¬ å¼€å§‹å¯¹è¯</h3>
                        <p>ç‚¹å‡»è§’è‰²å¡ç‰‡è¿›å…¥å¯¹è¯ç•Œé¢ï¼Œä¸è§’è‰²è¿›è¡ŒAIé©±åŠ¨çš„è‡ªç„¶å¯¹è¯</p>
                    </div>
                    <div class="guide-card">
                        <h3>âš™ï¸ é…ç½®AI</h3>
                        <p>éœ€è¦é…ç½®API Keyæ‰èƒ½ä½¿ç”¨AIå¯¹è¯åŠŸèƒ½ï¼Œæœªé…ç½®æ—¶å°†ä½¿ç”¨ç®€å•å›å¤</p>
                    </div>
                    <div class="guide-card">
                        <h3>ğŸŒ ç¤¾åŒºèµ„æº</h3>
                        <p>è®¿é—®SillyTavernç¤¾åŒºä¸‹è½½æµ·é‡è§’è‰²å¡ï¼Œå®Œå…¨å…¼å®¹ï¼</p>
                    </div>
                </div>
            </section>
        </main>

        <footer class="ct-footer">
            <p>&copy; 2025 ChatTavern | åŸºäºSillyTavernå…¼å®¹æ ¼å¼</p>
        </footer>
    </div>

    <!-- è§’è‰²å¡ç‰‡æ¨¡æ¿ -->
    <template id="characterCardTemplate">
        <div class="character-card" data-id="">
            <div class="character-avatar">
                <img src="" alt="">
            </div>
            <div class="character-info">
                <h3 class="character-name"></h3>
                <p class="character-desc"></p>
                <div class="character-tags"></div>
            </div>
            <div class="character-actions">
                <button class="btn-chat">å¼€å§‹å¯¹è¯</button>
                <button class="btn-delete">åˆ é™¤</button>
            </div>
        </div>
    </template>

    <!-- è„šæœ¬ -->
    <script src="../../js/settings-loader.js"></script>
    <script src="../../js/theme.js"></script>
    <script src="PNGCardReader.js"></script>
    <script src="PNGCardWriter.js"></script>
    <script src="CharacterCard.js"></script>
    <script src="DialogueMemory.js"></script>
    <script src="AIManager.js"></script>
    <script src="ChatTavern.js"></script>
    <script>
        // åˆå§‹åŒ–
        let chatTavern;

        document.addEventListener('DOMContentLoaded', async () => {
            chatTavern = new ChatTavern();
            await chatTavern.init();
            renderCharacterList();

            // ç»‘å®šäº‹ä»¶
            document.getElementById('selectFileBtn').addEventListener('click', () => {
                document.getElementById('fileInput').click();
            });

            document.getElementById('fileInput').addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file) {
                    await importCharacter(file);
                }
            });

            // æ‹–æ‹½æ”¯æŒ
            document.body.addEventListener('dragover', (e) => {
                e.preventDefault();
                document.body.classList.add('dragging');
            });

            document.body.addEventListener('dragleave', () => {
                document.body.classList.remove('dragging');
            });

            document.body.addEventListener('drop', async (e) => {
                e.preventDefault();
                document.body.classList.remove('dragging');

                const file = e.dataTransfer.files[0];
                if (file && file.type === 'image/png') {
                    await importCharacter(file);
                }
            });
        });

        // å¯¼å…¥è§’è‰²
        async function importCharacter(file) {
            try {
                await chatTavern.importPNGCard(file);
                alert('âœ… è§’è‰²å¡å¯¼å…¥æˆåŠŸï¼');
                renderCharacterList();
            } catch (error) {
                alert('âŒ å¯¼å…¥å¤±è´¥: ' + error.message);
            }
        }

        // æ¸²æŸ“è§’è‰²åˆ—è¡¨
        function renderCharacterList() {
            const characters = chatTavern.getCharacterList();
            const listEl = document.getElementById('characterList');
            const emptyEl = document.getElementById('emptyState');
            const countEl = document.getElementById('characterCount');

            countEl.textContent = characters.length;

            if (characters.length === 0) {
                emptyEl.style.display = 'block';
                listEl.style.display = 'none';
                return;
            }

            emptyEl.style.display = 'none';
            listEl.style.display = 'grid';
            listEl.innerHTML = '';

            characters.forEach(char => {
                const card = createCharacterCard(char);
                listEl.appendChild(card);
            });
        }

        // åˆ›å»ºè§’è‰²å¡ç‰‡
        function createCharacterCard(charData) {
            const character = chatTavern.characters.get(charData.id);
            const template = document.getElementById('characterCardTemplate');
            const clone = template.content.cloneNode(true);
            const card = clone.querySelector('.character-card');

            card.dataset.id = charData.id;

            const avatar = clone.querySelector('.character-avatar img');
            avatar.src = character.getSpriteUrl() || 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="40" fill="%236C63FF"/></svg>';
            avatar.alt = character.name;

            clone.querySelector('.character-name').textContent = character.name;
            clone.querySelector('.character-desc').textContent =
                character.description.substring(0, 80) + (character.description.length > 80 ? '...' : '');

            const tagsEl = clone.querySelector('.character-tags');
            character.tags.slice(0, 3).forEach(tag => {
                const tagSpan = document.createElement('span');
                tagSpan.className = 'tag';
                tagSpan.textContent = tag;
                tagsEl.appendChild(tagSpan);
            });

            clone.querySelector('.btn-chat').addEventListener('click', () => {
                location.href = `chat.html?id=${charData.id}`;
            });

            clone.querySelector('.btn-delete').addEventListener('click', async () => {
                if (confirm(`ç¡®å®šè¦åˆ é™¤è§’è‰²"${character.name}"å—ï¼Ÿ`)) {
                    chatTavern.deleteCharacter(charData.id);
                    renderCharacterList();
                }
            });

            return clone;
        }
    </script>
</body>
</html>
